<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="lzl" />
  <meta name="description" content="" />
  
  
  <title>
    
      SICP 学习笔记 (第三章) 
      
      
      |
    
     lzl&#39;s blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">lzl</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">SICP 学习笔记 (第三章)</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2023-07-02 15:04:05
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="Categories"></i>
                
                <span class="span--category">
                  <a href="/categories/Book/" title="Book">
                    <b>#</b> Book
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Scheme/" title="Scheme">
                    #Scheme
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Python/" title="Python">
                    #Python
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/SICP/" title="SICP">
                    #SICP
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1>Chapter 3: 模块化, 对象和状态</h1>
<p>前两章介绍了组成程序的基本元素, 把函数和数据组合在一起构造出复合的实体 <br>
认识到抽象有着至关重要的作用</p>
<p>但我们还需要一些能够帮助我们构造起模块化的大型系统的策略 <br>
使这些系统能够自然地划分为一些具有内聚力的部分, 从而使得这些部分能够分别开发和维护</p>
<p>有一种强有力的策略是基于被模拟系统的结构去设计程序的结构</p>
<ol>
<li>对于有关的物理系统里的每个对象, 我们构造起一个与之对应的计算对象</li>
<li>对于该系统中的每个活动, 在自己的计算系统中定义一种符号操作</li>
</ol>
<p>如果我们在系统的组织上非常成功, 那么在需要添加新特征或者排除旧东西错误的时候, 就只需要在局部工作</p>
<p>本章研究两种特点鲜明的组织策略</p>
<ol>
<li>将注意力集中在对象上, 将一个大型系统看成一大批对象</li>
<li>将注意力集中在流过系统的信息流上</li>
</ol>
<p>对于对象途径而言, 我们把必须关注计算对象可以怎么样变化又同时保证其标识 <br>
这将迫使我们抛弃老的计算的代换模型, 转向环境模型</p>
<p>流方式能够用于松解对时间的模拟和各种事件发生的顺序, 可以通过延时求值来做到这一点</p>
<h2 id="3-1-赋值和局部状态">3.1 赋值和局部状态</h2>
<p>我们可以使用几个变量来刻画一个对象的状态</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">balance = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">withdraw</span>(<span class="params">amount</span>):</span><br><span class="line">    <span class="keyword">global</span> balance</span><br><span class="line">    <span class="keyword">if</span> (balance &gt;= amount):</span><br><span class="line">        balance = balance - amount</span><br><span class="line">        <span class="keyword">return</span> balance</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Insufficient fundds&quot;</span></span><br></pre></td></tr></table></figure>
<p>之前的所有函数都可以看作数学函数, 因为他们对某些确定的参数只会返回确定的结果</p>
<p>但这样的实现有些问题, 因为 <code>balance</code> 被定义在全局, 可以被其他函数检查或者修改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">new_withdraw</span>():</span><br><span class="line">    balance = <span class="number">100</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">helper</span>(<span class="params">amount</span>):</span><br><span class="line">        <span class="keyword">nonlocal</span> balance</span><br><span class="line">        <span class="keyword">if</span> (balance &gt;= amount):</span><br><span class="line">            balance = balance - amount</span><br><span class="line">            <span class="keyword">return</span> balance</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Insufficient funds&quot;</span></span><br><span class="line">    <span class="keyword">return</span> helper</span><br><span class="line"></span><br><span class="line">x = new_withdraw()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(x(<span class="number">25</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Account</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, balance</span>):</span><br><span class="line">        self.balance = balance</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">withdraw</span>(<span class="params">self, amount</span>):</span><br><span class="line">        <span class="keyword">if</span> (self.balance &gt;= amount):</span><br><span class="line">            self.balance = self.balance - amount</span><br><span class="line">            <span class="keyword">return</span> self.balance</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Insufficient funds&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deposit</span>(<span class="params">self, amount</span>):</span><br><span class="line">        self.balance = self.balance</span><br><span class="line">        self.balance += amount</span><br><span class="line">        <span class="keyword">return</span> self.balance</span><br><span class="line"></span><br><span class="line">acc = Account(<span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(acc.withdraw(<span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(acc.withdraw(<span class="number">60</span>))</span><br><span class="line"><span class="built_in">print</span>(acc.deposit(<span class="number">40</span>))</span><br><span class="line"><span class="built_in">print</span>(acc.withdraw(<span class="number">60</span>))</span><br></pre></td></tr></table></figure>
<p>这类似于之前的消息传递过程</p>
<h3 id="3-1-2-引进赋值所带来的利益">3.1.2 引进赋值所带来的利益</h3>
<p>现在考虑如何设计出一个生成随机出的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x2 = rand_update(x1)</span><br><span class="line">x2 = rand_update(x2)</span><br></pre></td></tr></table></figure>
<p>蒙特卡洛模拟: 从大集合里面随机选择实验样本, 并对这些实验结果的统计估计做出推断</p>
<p>随机选取的两个整数之间最大公约数是 1 的概率为 $\frac{6}{\pi ^2}$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">estimate_pi</span>(<span class="params">trials</span>):</span><br><span class="line">    <span class="keyword">return</span> math.sqrt(<span class="number">6</span> / monte_carlo(trials, cesaro_test))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cesaro_test</span>():</span><br><span class="line">    <span class="keyword">return</span> math.gcd(random.randint(<span class="number">1</span>, <span class="number">100000</span>), random.randint(<span class="number">1</span>, <span class="number">100000</span>)) == <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">monte_carlo</span>(<span class="params">trials, experiment</span>):</span><br><span class="line">    passed_trials = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(trials):</span><br><span class="line">        <span class="keyword">if</span> (experiment()):</span><br><span class="line">            passed_trials += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> passed_trials / trials</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(estimate_pi(<span class="number">1000000</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rand_update</span>(<span class="params">_</span>):</span><br><span class="line">    <span class="keyword">return</span> random.randint(<span class="number">1</span>, <span class="number">1000000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_gcd_test</span>(<span class="params">trials, initial_x</span>):</span><br><span class="line">    x = initial_x</span><br><span class="line">    passed_trials = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(trials):</span><br><span class="line">        x1 = rand_update(x)</span><br><span class="line">        x2 = rand_update(x1)</span><br><span class="line">        <span class="keyword">if</span> (math.gcd(x1, x2) == <span class="number">1</span>):</span><br><span class="line">            passed_trials += <span class="number">1</span></span><br><span class="line">        x = x2</span><br><span class="line">    <span class="keyword">return</span> passed_trials / trials</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(math.sqrt(<span class="number">6</span> / random_gcd_test(<span class="number">100000</span>, <span class="number">1</span>)))</span><br></pre></td></tr></table></figure>
<p>第一段不需要显式地操作 $x_1$, $x_2$, 而且生成随机数的操作被隔离, 可以更好地进行模块化</p>
<p>与所有状态都必须显式地操作和传递额外参数的方法相比 <br>
通过引进赋值和将状态隐藏在局部变量的技术, 可以让我们以一种更模块化的方式来构造系统</p>
<h3 id="3-1-3-引进赋值的代价">3.1.3 引进赋值的代价</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_simplified_withdraw</span>(<span class="params">balance</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">helper</span>(<span class="params">amount</span>):</span><br><span class="line">        <span class="keyword">nonlocal</span> balance</span><br><span class="line">        balance -= amount</span><br><span class="line">        <span class="keyword">return</span> balance</span><br><span class="line">    <span class="keyword">return</span> helper</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_decrementer</span>(<span class="params">balance</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">lambda</span> amount: balance - amount</span><br></pre></td></tr></table></figure>
<p>只要我们不适用赋值, 同样参数对于同一函数的两次求值结果必然相同, 相当于计算数学函数 \</p>
<p>代换模型的基础是: 变量只不过是值的名字</p>
<p>但是引入赋值之后, 一个变量就索引着一个保存值的位置</p>
<p><strong>同一和变化</strong>:</p>
<p>如果一个语言支持在表达式里&quot;同一的东西可以相互替换&quot;, <br>
这种替换不会改变表达式的值, 这个语言就具有<strong>引用透明性</strong></p>
<p>包含赋值操作也就打破了引用透明性</p>
<p>不用任何赋值的程序设计称为函数式编程 <br>
大量使用赋值的程序设计称为命令式编程</p>
<p>命令式编程的一个问题式需要考虑赋值的先后顺序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">factorial</span>(<span class="params">n</span>):</span><br><span class="line">    product, counter = <span class="number">1</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        product *= counter</span><br><span class="line">        counter += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> product</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(factorial(<span class="number">5</span>))</span><br></pre></td></tr></table></figure>
<p>更换 <code>product</code> 和 <code>counter</code> 的求值顺序, 结果就会变得不同 <br>
所以带有赋值的程序强迫人们去考虑赋值的相对顺序 <br>
而在函数式编程中, 这样的问题根本不会存在 <br>
在考虑并发执行的进程中, 命令式编程的复杂度还会增加</p>
<h2 id="3-2-求值的环境模型">3.2 求值的环境模型</h2>
<p>一个环境就是框架的一个序列, 每个框架是包含着约束的表格 <br>
这些约束将一些变量名字关联于对应的值, 并且在同一个框架里, 一个变量至多只能有一个约束</p>
<p>每个框架还包含着一个指针, 指向这一框架的外围环境 (全局的框架没有这个指针)</p>
<h3 id="3-2-1-求值规则">3.2.1 求值规则</h3>
<p>在求值的环境模型里 <br>
将一个函数应用于一些实参, 将构造出一个新框架, 将函数中的形参约束到调用时的实参 <br>
之后在构造的新环境的上下文中求值函数主体, 新框架的外围环境就是调用函数时的环境</p>
<h3 id="3-2-2-简单过程的应用">3.2.2 简单过程的应用</h3>
<p>本节分析一个实例</p>
<h3 id="3-2-3-将框架看作局部状态的展台">3.2.3 将框架看作局部状态的展台</h3>
<p>本节分析另一个实例</p>
<h3 id="3-2-4-内部定义">3.2.4 内部定义</h3>
<p>内部定义的函数被约束到当前环境中</p>
<h2 id="3-3-用变动数据做模拟">3.3 用变动数据做模拟</h2>
<p>在第二章中, 各种数据抽象包括选择函数和构造函数 <br>
现在我们要加入改变函数</p>
<h3 id="3-3-1-变动的表结构">3.3.1 变动的表结构</h3>
<p>第一部分讲了 <code>set-car</code>, <code>set-cdr</code></p>
<p>第二部分: 共享和相等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">b = [a] + [a]</span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line">b[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"></span><br><span class="line">b = [[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">1</span>, <span class="number">2</span>]]</span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"></span><br><span class="line">b[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure>
<p>两次输出不同</p>
<p>通过 <code>is</code> 检查两者地址是否相同</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">b = [a] + [a]</span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line">b[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(b[<span class="number">0</span>] <span class="keyword">is</span> b[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">b = [[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">1</span>, <span class="number">2</span>]]</span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"></span><br><span class="line">b[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(b[<span class="number">0</span>] <span class="keyword">is</span> b[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<h1>练习</h1>
<h2 id="3-1">3.1</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_accumulater</span>(<span class="params"><span class="built_in">sum</span></span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">helper</span>(<span class="params">x</span>):</span><br><span class="line">        <span class="keyword">nonlocal</span> <span class="built_in">sum</span></span><br><span class="line">        <span class="built_in">sum</span> += x</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span></span><br><span class="line">    <span class="keyword">return</span> helper</span><br><span class="line"></span><br><span class="line">A = make_accumulater(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(A(<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(A(<span class="number">10</span>))</span><br></pre></td></tr></table></figure>
<h2 id="3-2">3.2</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_monitored</span>(<span class="params">func</span>):</span><br><span class="line">    times = <span class="number">0</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dispatch</span>(<span class="params">x</span>):</span><br><span class="line">        <span class="keyword">nonlocal</span> times</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="string">&quot;how_many_calls?&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span> times</span><br><span class="line">        <span class="keyword">elif</span> (x == <span class="string">&quot;reset_count&quot;</span>):</span><br><span class="line">            times = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            times += <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> func(x)</span><br><span class="line">    <span class="keyword">return</span> dispatch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s = make_monitored(math.sqrt)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s(<span class="number">100</span>))</span><br><span class="line"><span class="built_in">print</span>(s(<span class="string">&quot;how_many_calls?&quot;</span>))</span><br><span class="line">s(<span class="string">&quot;reset_count&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s(<span class="number">144</span>))</span><br><span class="line"><span class="built_in">print</span>(s(<span class="string">&quot;how_many_calls?&quot;</span>))</span><br></pre></td></tr></table></figure>
<h2 id="3-3">3.3</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Account</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, balance, password</span>):</span><br><span class="line">        self.balance = balance</span><br><span class="line">        self.password = password</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">withdraw</span>(<span class="params">self, password, amount</span>):</span><br><span class="line">        <span class="keyword">if</span> (password != self.password):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Incorrect password&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self.balance &gt;= amount):</span><br><span class="line">            self.balance = self.balance - amount</span><br><span class="line">            <span class="keyword">return</span> self.balance</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Insufficient funds&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deposit</span>(<span class="params">self, amount</span>):</span><br><span class="line">        self.balance = self.balance</span><br><span class="line">        self.balance += amount</span><br><span class="line">        <span class="keyword">return</span> self.balance</span><br><span class="line"></span><br><span class="line">s = Account(<span class="number">100</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;3&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br></pre></td></tr></table></figure>
<h2 id="3-4">3.4</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">call_the_cops = <span class="keyword">lambda</span>: <span class="string">&quot;cops are coming&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Account</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, balance, password</span>):</span><br><span class="line">        self.balance = balance</span><br><span class="line">        self.password = password</span><br><span class="line">        self.times = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">withdraw</span>(<span class="params">self, password, amount</span>):</span><br><span class="line">        <span class="keyword">if</span> (password != self.password):</span><br><span class="line">            self.times += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> (self.times == <span class="number">7</span>):</span><br><span class="line">                <span class="keyword">return</span> call_the_cops()</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Incorrect password&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self.balance &gt;= amount):</span><br><span class="line">            self.balance = self.balance - amount</span><br><span class="line">            <span class="keyword">return</span> self.balance</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Insufficient funds&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deposit</span>(<span class="params">self, amount</span>):</span><br><span class="line">        self.balance = self.balance</span><br><span class="line">        self.balance += amount</span><br><span class="line">        <span class="keyword">return</span> self.balance</span><br><span class="line"></span><br><span class="line">s = Account(<span class="number">100</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;3&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br><span class="line"><span class="built_in">print</span>(s.withdraw(<span class="string">&quot;4&quot;</span>, <span class="number">50</span>))</span><br></pre></td></tr></table></figure>
<h2 id="3-5">3.5</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">x0, y0, r = <span class="number">100</span>, <span class="number">100</span>, <span class="number">50</span> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">estimate_integral</span>(<span class="params">p, x1, x2, y1, y2, trails</span>):</span><br><span class="line">    experiment = <span class="keyword">lambda</span>: p(x1, x2, y1, y2)</span><br><span class="line">    s = <span class="built_in">abs</span>(x1 - x2) * <span class="built_in">abs</span>(y1 - y2)</span><br><span class="line">    <span class="keyword">return</span> s * monte_carlo(trails, experiment) / r / r</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">p</span>(<span class="params">x1, x2, y1, y2</span>):</span><br><span class="line">    x = random.randint(x1, x2) - x0</span><br><span class="line">    y = random.randint(y1, y2) - y0</span><br><span class="line">    <span class="keyword">return</span> x * x + y * y &lt;= r * r</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(estimate_integral(p, <span class="number">0</span>, <span class="number">200</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="number">100000</span>))</span><br></pre></td></tr></table></figure>
<h2 id="3-6">3.6</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Rand</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, init</span>):</span><br><span class="line">        self.cur = init</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">update_func</span>(<span class="params">x</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        self.cur = update_func(self.cur)</span><br><span class="line">        <span class="keyword">return</span> self.cur</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.calculate()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">self, new_value</span>):</span><br><span class="line">        self.cur = new_value</span><br></pre></td></tr></table></figure>
<h2 id="3-7">3.7</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">call_the_cops = <span class="keyword">lambda</span>: <span class="string">&quot;cops are coming&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Account</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, balance, password</span>):</span><br><span class="line">        self.balance = balance</span><br><span class="line">        self.password = password</span><br><span class="line">        self.times = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrong_password</span>(<span class="params">self</span>):</span><br><span class="line">        self.times += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> self.times == <span class="number">7</span>:</span><br><span class="line">            <span class="keyword">return</span> call_the_cops()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Incorrect password&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">withdraw</span>(<span class="params">self, password, amount</span>):</span><br><span class="line">        <span class="keyword">if</span> password != self.password:</span><br><span class="line">            <span class="keyword">return</span> self.wrong_password()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.balance &gt;= amount:</span><br><span class="line">            self.balance -= amount</span><br><span class="line">            <span class="keyword">return</span> self.balance</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Insufficient funds&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deposit</span>(<span class="params">self, amount</span>):</span><br><span class="line">        self.balance += amount</span><br><span class="line">        <span class="keyword">return</span> self.balance</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_joint</span>(<span class="params">self, old_pass, new_pass</span>):</span><br><span class="line">        <span class="keyword">if</span> old_pass != self.password:</span><br><span class="line">            <span class="keyword">return</span> self.wrong_password()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">JointAccount</span>(<span class="title class_ inherited__">Account</span>):</span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, original_account, new_pass</span>):</span><br><span class="line">                self.ori = original_account</span><br><span class="line">                self.password = new_pass</span><br><span class="line">                self.times = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">withdraw</span>(<span class="params">self, password, amount</span>):</span><br><span class="line">                <span class="keyword">if</span> (password == self.password):</span><br><span class="line">                    <span class="keyword">return</span> self.ori.withdraw(self.ori.password, amount)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">deposit</span>(<span class="params">self, amount</span>):</span><br><span class="line">                <span class="keyword">return</span> self.ori.deposit(amount)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JointAccount(self, new_pass)</span><br><span class="line"></span><br><span class="line">peter = Account(<span class="number">100</span>, <span class="string">&quot;111&quot;</span>)</span><br><span class="line">paul = peter.make_joint(<span class="string">&quot;111&quot;</span>, <span class="string">&quot;222&quot;</span>)</span><br><span class="line"><span class="keyword">assert</span>(<span class="built_in">isinstance</span>(paul, Account)) <span class="comment">#type: ignore</span></span><br><span class="line">amy = paul.make_joint(<span class="string">&quot;222&quot;</span>, <span class="string">&quot;333&quot;</span>)</span><br><span class="line"><span class="keyword">assert</span>(<span class="built_in">isinstance</span>(amy, Account)) <span class="comment">#type: ignore</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(peter.withdraw(<span class="string">&quot;111&quot;</span>, <span class="number">10</span>))  <span class="comment"># 输出: 90</span></span><br><span class="line"><span class="built_in">print</span>(peter.deposit(<span class="number">30</span>))</span><br><span class="line"><span class="built_in">print</span>(paul.withdraw(<span class="string">&quot;222&quot;</span>, <span class="number">10</span>))  <span class="comment"># 输出: 80</span></span><br><span class="line"><span class="built_in">print</span>(paul.deposit(<span class="number">30</span>))</span><br><span class="line"><span class="built_in">print</span>(amy.withdraw(<span class="string">&quot;333&quot;</span>, <span class="number">10</span>))  <span class="comment"># 输出: 70</span></span><br><span class="line"><span class="built_in">print</span>(amy.deposit(<span class="number">30</span>))</span><br></pre></td></tr></table></figure>
<p>还有另外一种取巧的写法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">call_the_cops = <span class="keyword">lambda</span>: <span class="string">&quot;cops are coming&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Account</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, balance, password</span>):</span><br><span class="line">        self.balance = balance</span><br><span class="line">        self.password = [password]</span><br><span class="line">        self.times = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrong_password</span>(<span class="params">self</span>):</span><br><span class="line">        self.times += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> self.times == <span class="number">7</span>:</span><br><span class="line">            <span class="keyword">return</span> call_the_cops()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Incorrect password&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">withdraw</span>(<span class="params">self, password, amount</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> password <span class="keyword">in</span> self.password:</span><br><span class="line">            <span class="keyword">return</span> self.wrong_password()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.balance &gt;= amount:</span><br><span class="line">            self.balance -= amount</span><br><span class="line">            <span class="keyword">return</span> self.balance</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Insufficient funds&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deposit</span>(<span class="params">self, amount</span>):</span><br><span class="line">        self.balance += amount</span><br><span class="line">        <span class="keyword">return</span> self.balance</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_joint</span>(<span class="params">self, old_pass, new_pass</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> old_pass <span class="keyword">in</span> self.password:</span><br><span class="line">            <span class="keyword">return</span> self.wrong_password()</span><br><span class="line">        self.password += [new_pass]</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">peter = Account(<span class="number">100</span>, <span class="string">&quot;111&quot;</span>)</span><br><span class="line">paul = peter.make_joint(<span class="string">&quot;111&quot;</span>, <span class="string">&quot;222&quot;</span>)</span><br><span class="line"><span class="keyword">assert</span>(<span class="built_in">isinstance</span>(paul, Account)) <span class="comment">#type: ignore</span></span><br><span class="line">amy = paul.make_joint(<span class="string">&quot;222&quot;</span>, <span class="string">&quot;333&quot;</span>)</span><br><span class="line"><span class="keyword">assert</span>(<span class="built_in">isinstance</span>(amy, Account)) <span class="comment">#type: ignore</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(peter.withdraw(<span class="string">&quot;111&quot;</span>, <span class="number">10</span>))  <span class="comment"># 输出: 90</span></span><br><span class="line"><span class="built_in">print</span>(peter.deposit(<span class="number">30</span>))</span><br><span class="line"><span class="built_in">print</span>(paul.withdraw(<span class="string">&quot;222&quot;</span>, <span class="number">10</span>))  <span class="comment"># 输出: 80</span></span><br><span class="line"><span class="built_in">print</span>(paul.deposit(<span class="number">30</span>))</span><br><span class="line"><span class="built_in">print</span>(amy.withdraw(<span class="string">&quot;333&quot;</span>, <span class="number">10</span>))  <span class="comment"># 输出: 70</span></span><br><span class="line"><span class="built_in">print</span>(amy.deposit(<span class="number">30</span>))</span><br></pre></td></tr></table></figure>
<h2 id="3-8">3.8</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">1</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f</span>(<span class="params">y</span>):</span><br><span class="line">    <span class="keyword">global</span> x</span><br><span class="line">    x *= y</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">a = f(<span class="number">0</span>)</span><br><span class="line">b = f(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a + b)</span><br><span class="line"></span><br><span class="line">x = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">a = f(<span class="number">1</span>)</span><br><span class="line">b = f(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a + b)</span><br></pre></td></tr></table></figure>
<h2 id="3-9">3.9</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">                +------------------------------------------------------------------------------------------+</span><br><span class="line"><span class="keyword">global</span> env --&gt;  |                                                                                          |</span><br><span class="line">                |                                                                                          |</span><br><span class="line">                +------------------------------------------------------------------------------------------+</span><br><span class="line">                   ^               ^              ^                ^               ^               ^</span><br><span class="line">            (f <span class="number">6</span>)  |        (f <span class="number">5</span>)  |       (f <span class="number">4</span>)  |         (f <span class="number">3</span>)  |        (f <span class="number">2</span>)  |        (f <span class="number">1</span>)  |</span><br><span class="line">                   |               |              |                |               |               |</span><br><span class="line">                +------+        +------+        +------+         +------+        +------+        +------+</span><br><span class="line">                |      |        |      |        |      |         |      |        |      |        |      |</span><br><span class="line">          E1 -&gt; | n: <span class="number">6</span> |  E2-&gt;  | n: <span class="number">5</span> |  E3 -&gt; | n: <span class="number">4</span> |  E4 -&gt;  | n: <span class="number">3</span> |  E5 -&gt; | n: <span class="number">2</span> |  E6 -&gt; | n: <span class="number">1</span> |</span><br><span class="line">                |      |        |      |        |      |         |      |        |      |        |      |</span><br><span class="line">                +------+        +------+        +------+         +------+        +------+        +------+</span><br><span class="line"></span><br><span class="line">             (* <span class="number">6</span> (f <span class="number">5</span>))      (* <span class="number">5</span> (f <span class="number">4</span>))     (* <span class="number">4</span> (f <span class="number">3</span>))      (* <span class="number">3</span> (f <span class="number">2</span>))     (* <span class="number">2</span> (f <span class="number">1</span>))        <span class="number">1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">         +-----------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line"><span class="keyword">global</span>   |                                                                                                                             |</span><br><span class="line">env --&gt;  |                                                                                                                             |</span><br><span class="line">         |                                                                                                                             |</span><br><span class="line">         +-----------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">            ^               ^                 ^                ^               ^                 ^                  ^               ^</span><br><span class="line">      (f <span class="number">6</span>) |     (i <span class="number">1</span> <span class="number">1</span> <span class="number">6</span>) |       (i <span class="number">1</span> <span class="number">2</span> <span class="number">6</span>) |      (i <span class="number">2</span> <span class="number">3</span> <span class="number">6</span>) |     (i <span class="number">6</span> <span class="number">4</span> <span class="number">6</span>) |      (i <span class="number">24</span> <span class="number">5</span> <span class="number">6</span>) |      (i <span class="number">120</span> <span class="number">6</span> <span class="number">6</span>) |   (i <span class="number">720</span> <span class="number">7</span> <span class="number">6</span>) |</span><br><span class="line">            |               |                 |                |               |                 |                  |               |</span><br><span class="line">        +-------+        +-------+        +-------+        +-------+        +-------+        +-------+        +-------+        +-------+</span><br><span class="line">        |       |        | p: <span class="number">1</span>  |        | p: <span class="number">1</span>  |        | p: <span class="number">2</span>  |        | p: <span class="number">6</span>  |        | p: <span class="number">24</span> |        | p:<span class="number">120</span> |        | p:<span class="number">720</span> |</span><br><span class="line">  E1 -&gt; | n: <span class="number">6</span>  |  E2 -&gt; | c: <span class="number">1</span>  |  E3 -&gt; | c: <span class="number">2</span>  |  E4 -&gt; | c: <span class="number">3</span>  |  E5 -&gt; | c: <span class="number">4</span>  |  E6 -&gt; | c: <span class="number">5</span>  |  E7 -&gt; | c: <span class="number">6</span>  |  E8 -&gt; | c: <span class="number">7</span>  |</span><br><span class="line">        |       |        | m: <span class="number">6</span>  |        | m: <span class="number">6</span>  |        | m: <span class="number">6</span>  |        | m: <span class="number">6</span>  |        | m: <span class="number">6</span>  |        | m: <span class="number">6</span>  |        | m: <span class="number">6</span>  |</span><br><span class="line">        +-------+        +-------+        +-------+        +-------+        +-------+        +-------+        +-------+        +-------+</span><br><span class="line">        (i <span class="number">1</span> <span class="number">1</span> <span class="number">6</span>)        (i <span class="number">1</span> <span class="number">2</span> <span class="number">6</span>)        (i <span class="number">2</span> <span class="number">3</span> <span class="number">6</span>)        (i <span class="number">6</span> <span class="number">4</span> <span class="number">6</span>)       (i <span class="number">24</span> <span class="number">5</span> <span class="number">6</span>)       (i <span class="number">120</span> <span class="number">6</span> <span class="number">6</span>)      (i <span class="number">720</span> <span class="number">7</span> <span class="number">6</span>)       <span class="number">720</span></span><br></pre></td></tr></table></figure>
<h2 id="3-10">3.10</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">              +-----------------------------------------------------------------------------------------+</span><br><span class="line">global env -&gt; |                                                                                         |</span><br><span class="line">              |   w1                                        w2                                          |</span><br><span class="line">              +---|-----------------------------------------|-------------------------------------------+</span><br><span class="line">                  |                               ^         |                               ^</span><br><span class="line">                  |          (make-withdraw 100)  |         |                               |</span><br><span class="line">                  |                               |         |                               |</span><br><span class="line">                  |                    +--------------+     |                      +--------------+</span><br><span class="line">                  |                    |              |     |                      |              |</span><br><span class="line">                  |             E1 -&gt;  | initial: 100 |     |               E1 -&gt;  | initial: 100 |</span><br><span class="line">                  |                    |              |     |                      |              |</span><br><span class="line">                  |                    +--------------+     |                      +--------------+</span><br><span class="line">                  |                               ^         |                               ^</span><br><span class="line">                  | ((lambda (balance) ...) 100)  |         | ((lambda (balance) ...) 100)  |</span><br><span class="line">                  |                               |         |                               |</span><br><span class="line">                  |                    +--------------+     |                      +--------------+</span><br><span class="line">                  |                    |              |     |                      |              |</span><br><span class="line">                  |             E2 -&gt;  | balance: 50  |     |               E2 -&gt;  | balance: 100 |</span><br><span class="line">                  |                    |              |     |                      |              |</span><br><span class="line">                  |                    +--------------+     |                      +--------------+</span><br><span class="line">                  |                      |        ^         |                          |       ^</span><br><span class="line">                  |                      |        |         |                          |       |</span><br><span class="line">                  |                      v        |         |                          v       |</span><br><span class="line">                  +------------------&gt; [*][*]-----+         +-----------------------&gt;[*][*]----+</span><br><span class="line">                                        |                                             |</span><br><span class="line">                                        |                                             |</span><br><span class="line">                                        v                                             v</span><br><span class="line">                         parameters: amount                             parameters: amount</span><br><span class="line">                         body: (if (&gt;= balance amount)                  body: (if (&gt;= balance amount)</span><br><span class="line">                                   (begin (set! balance                           (begin (set! balance</span><br><span class="line">                                                (- balance amount))                      (- balance amount))</span><br><span class="line">                                          balance)                                balance)</span><br><span class="line">                                   &quot;Insufficient funds&quot;)                          &quot;Insufficient funds&quot;)</span><br></pre></td></tr></table></figure>
<h2 id="3-11">3.11</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">          +---------------------------------------------------------------+</span><br><span class="line">global -&gt; |                                                               |</span><br><span class="line">env       | make-account        acc2    acc                               |</span><br><span class="line">          +----|-----------------|--------|-------------------------------+</span><br><span class="line">               |       ^         |        |             ^</span><br><span class="line">               |       |         |        |             |</span><br><span class="line">               v       |         |        |   E1 -&gt; +------------------+</span><br><span class="line">             [*][*]----+         |        |         | balance: 30      |&lt;----------+</span><br><span class="line">              |                  |        |         |                  |           |</span><br><span class="line">              |                  |        |         | withdraw ---------------&gt;[*][*]----&gt; parameters: amount</span><br><span class="line">              v                  |        |         |                  |                   body: ...</span><br><span class="line">  parameters: balance            |        |         |                  |&lt;----------+</span><br><span class="line">  body: (define withdraw ...)    |        |         |                  |           |</span><br><span class="line">        (define deposit ...)     |        |         | deposit ----------------&gt;[*][*]----&gt; parameters: amount</span><br><span class="line">        (define dispatch ...)    |        |         |                  |                   body: ...</span><br><span class="line">        (lambda (m) ...)         |        |         |                  |&lt;----------+</span><br><span class="line">                                 |        |         |                  |           |</span><br><span class="line">                                 |        +----------&gt;dispatch ---------------&gt;[*][*]----&gt; parameters: m</span><br><span class="line">                                 |                  |                  |                   body: ...</span><br><span class="line">                                 |                  +------------------+</span><br><span class="line">                                 |</span><br><span class="line">                                 |</span><br><span class="line">                                 |</span><br><span class="line">                                 |  E6 -&gt; +------------------+</span><br><span class="line">                                 |        | balance: 100     |&lt;----------+</span><br><span class="line">                                 |        |                  |           |</span><br><span class="line">                                 |        | withdraw ---------------&gt;[*][*]----&gt; parameters: amount</span><br><span class="line">                                 |        |                  |                   body: ...</span><br><span class="line">                                 |        |                  |&lt;----------+</span><br><span class="line">                                 |        |                  |           |</span><br><span class="line">                                 |        | deposit ----------------&gt;[*][*]----&gt; parameters: amount</span><br><span class="line">                                 |        |                  |                   body: ...</span><br><span class="line">                                 |        |                  |&lt;----------+</span><br><span class="line">                                 |        |                  |           |</span><br><span class="line">                                 +---------&gt;dispatch ---------------&gt;[*][*]----&gt; parameters: m</span><br><span class="line">                                          |                  |                   body: ...</span><br><span class="line">                                          +------------------+</span><br></pre></td></tr></table></figure>
<p><code>acc</code> 的局部状态保存在环境 <code>E1</code> 中 <br>
因为环境不同, 所以局部状态不同 <br>
两者并不共享任何部分</p>
<h2 id="3-12">3.12</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">x --&gt; [*]----&gt; [*]----&gt; &#x27;()</span><br><span class="line">       |        |</span><br><span class="line">       v        v</span><br><span class="line">       &#x27;a       &#x27;b</span><br><span class="line"></span><br><span class="line">y --&gt; [*]----&gt; [*]----&gt; &#x27;()</span><br><span class="line">       |        |</span><br><span class="line">       v        v</span><br><span class="line">       &#x27;c       &#x27;d</span><br><span class="line"></span><br><span class="line">z --&gt; [*]----&gt;[*]----&gt;[*]----&gt;[*]----&gt; &#x27;()</span><br><span class="line">       |       |       |       |</span><br><span class="line">       v       v       v       v</span><br><span class="line">      &#x27;a      &#x27;b      &#x27;c      &#x27;d</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">w------+</span><br><span class="line">       |</span><br><span class="line">       |</span><br><span class="line">       v</span><br><span class="line">x --&gt; [*]----&gt; [*]----+</span><br><span class="line">       |        |     |</span><br><span class="line">       v        v     |</span><br><span class="line">       &#x27;a       &#x27;b    |</span><br><span class="line">                      |</span><br><span class="line">       +--------------+</span><br><span class="line">       |</span><br><span class="line">       v</span><br><span class="line">y --&gt; [*]----&gt; [*]----&gt; &#x27;()</span><br><span class="line">       |        |</span><br><span class="line">       v        v</span><br><span class="line">       &#x27;c       &#x27;d</span><br><span class="line"></span><br><span class="line">z --&gt; [*]----&gt;[*]----&gt;[*]----&gt;[*]----&gt; &#x27;()</span><br><span class="line">       |       |       |       |</span><br><span class="line">       v       v       v       v</span><br><span class="line">      &#x27;a      &#x27;b      &#x27;c      &#x27;d</span><br></pre></td></tr></table></figure>
<p>两个 <code>&lt;response&gt;</code>:</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">b</span>)</span><br><span class="line">(<span class="name">b</span> c d)</span><br></pre></td></tr></table></figure>
<h2 id="3-13">3.13</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">         +-----------------------+</span><br><span class="line">         |                       |</span><br><span class="line">         v                       |</span><br><span class="line">z ----&gt; [*]----&gt; [*]----&gt; [*]----+</span><br><span class="line">         |        |        |</span><br><span class="line">         v        v        v</span><br><span class="line">        &#x27;a       &#x27;b       &#x27;c</span><br></pre></td></tr></table></figure>
<p>无限循环</p>
<h2 id="3-14">3.14</h2>
<p>数组反转</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">a</span> b c d)</span><br><span class="line">(<span class="name">d</span> c b a)</span><br></pre></td></tr></table></figure>
<h2 id="3-15">3.15</h2>
<p>改变的是 <code>x</code></p>
<p><code>z1</code> 变两个<br>
<code>z2</code> 只变一个</p>
<h2 id="3-16">3.16</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">car = <span class="keyword">lambda</span> x: x[<span class="number">0</span>]</span><br><span class="line">cdr = <span class="keyword">lambda</span> x: x[<span class="number">1</span>:] <span class="keyword">if</span> <span class="built_in">len</span>(x) &gt; <span class="number">1</span> <span class="keyword">else</span> []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">count_pairs</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> <span class="built_in">type</span>(x) == <span class="built_in">list</span> <span class="keyword">or</span> x == []):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> count_pairs(car(x)) + count_pairs(cdr(x)) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">c</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inner</span>(<span class="params">x, memo_list</span>):</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">type</span>(x) == <span class="built_in">list</span> <span class="keyword">and</span> x != []</span><br><span class="line">            <span class="keyword">and</span> (<span class="keyword">not</span> x <span class="keyword">in</span> memo_list)):</span><br><span class="line">            <span class="keyword">return</span> inner(car(x), inner(cdr(x), [x] + memo_list))</span><br><span class="line">        <span class="keyword">return</span> memo_list</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(inner(x, []))</span><br><span class="line"></span><br><span class="line">x = [[<span class="number">1</span>], <span class="number">2</span>]</span><br><span class="line">y = [[[<span class="number">1</span>]], <span class="number">1</span>]</span><br><span class="line">z = [[[<span class="number">1</span>], <span class="number">1</span>], [<span class="number">1</span>], <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(count_pairs(x), c(x))</span><br><span class="line"><span class="built_in">print</span>(count_pairs(y), c(y))</span><br><span class="line"><span class="built_in">print</span>(count_pairs(z), c(z))</span><br></pre></td></tr></table></figure>
<h2 id="3-17">3.17</h2>
<p>见 3.16</p>
<h2 id="3-18">3.18</h2>
<p>用 <code>python</code> 中的 <code>list</code> 实在是不好模拟, 所以用链表<br>
直接用的快慢指针法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LinkNode</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, val, <span class="built_in">next</span></span>):</span><br><span class="line">        self.val, self.<span class="built_in">next</span> = val, <span class="built_in">next</span></span><br><span class="line"></span><br><span class="line">x = LinkNode(<span class="number">3</span>, LinkNode(<span class="number">4</span>, LinkNode(<span class="number">5</span>, <span class="literal">None</span>)))</span><br><span class="line"></span><br><span class="line">x.<span class="built_in">next</span> = x</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">head</span>):</span><br><span class="line">    <span class="keyword">if</span> (head == <span class="literal">None</span> <span class="keyword">or</span> head.<span class="built_in">next</span> == <span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    slow, fast = head, head.<span class="built_in">next</span></span><br><span class="line">    <span class="keyword">while</span> (fast <span class="keyword">and</span> fast.<span class="built_in">next</span>):</span><br><span class="line">        <span class="keyword">if</span> (slow == fast):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        slow, fast = slow.<span class="built_in">next</span>, fast.<span class="built_in">next</span>.<span class="built_in">next</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(check(x))</span><br></pre></td></tr></table></figure>
<h2 id="3-19">3.19</h2>
<p>见 3.18</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">          +-------------------------------------------------------+</span><br><span class="line">global -&gt; |                                                       |</span><br><span class="line">env       |  z                           x                        |</span><br><span class="line">          +--|---------------------------|------------------------+</span><br><span class="line">             |           ^               |          ^</span><br><span class="line">             |           |               |          |</span><br><span class="line">             |           |               |      +----------+</span><br><span class="line">             |           |               |      | x: 17    |</span><br><span class="line">             |           |               |      | y: 2     |</span><br><span class="line">             |           |               |      |          |</span><br><span class="line">             |           |               |      | set-x! -----&gt; ...</span><br><span class="line">             |           |               |      | set-y! -----&gt; ...</span><br><span class="line">             |           |               +-------&gt;dispatch ---&gt; parameters: m</span><br><span class="line">             |           |                      |  ^ ^     |    body: ...</span><br><span class="line">             |           |                      +--|-|-----+</span><br><span class="line">             |        +----------+                 | |</span><br><span class="line">             |  E2 -&gt; | x: ------------------------+ |</span><br><span class="line">             |        | y: --------------------------+</span><br><span class="line">             |        |          |</span><br><span class="line">             |        | set-x! -----&gt; ...</span><br><span class="line">             |        | set-y! -----&gt; ...</span><br><span class="line">             +---------&gt;dispatch ---&gt; parameters: m</span><br><span class="line">                      |          |    body: (cond ((eq? m &#x27;car) &#x27;car)</span><br><span class="line">                      +----------+                ((eq? m &#x27;cdr) &#x27;cdr)</span><br><span class="line">                                                  ((eq? m &#x27;set-car!) &#x27;set-car!)</span><br><span class="line">                                                  ((eq? m &#x27;set-cdr!) &#x27;set-cdr!)</span><br><span class="line">                                                  (else</span><br><span class="line">                                                    (error &quot;...&quot; m)))</span><br></pre></td></tr></table></figure>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2023/07/01/scheme/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2023-07-02 15:04:05
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="Categories"></i>
                    
                    <span class="span--category">
                      <a href="/categories/Book/" title="Book">
                        <b>#</b> Book
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Scheme/" title="Scheme">
                        #Scheme
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Python/" title="Python">
                        #Python
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/SICP/" title="SICP">
                        #SICP
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2023/07/02/2sicp/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">Chapter 3: 模块化, 对象和状态</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E8%B5%8B%E5%80%BC%E5%92%8C%E5%B1%80%E9%83%A8%E7%8A%B6%E6%80%81"><span class="toc-text">3.1 赋值和局部状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-%E5%BC%95%E8%BF%9B%E8%B5%8B%E5%80%BC%E6%89%80%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%88%A9%E7%9B%8A"><span class="toc-text">3.1.2 引进赋值所带来的利益</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-%E5%BC%95%E8%BF%9B%E8%B5%8B%E5%80%BC%E7%9A%84%E4%BB%A3%E4%BB%B7"><span class="toc-text">3.1.3 引进赋值的代价</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E6%B1%82%E5%80%BC%E7%9A%84%E7%8E%AF%E5%A2%83%E6%A8%A1%E5%9E%8B"><span class="toc-text">3.2 求值的环境模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E6%B1%82%E5%80%BC%E8%A7%84%E5%88%99"><span class="toc-text">3.2.1 求值规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-%E7%AE%80%E5%8D%95%E8%BF%87%E7%A8%8B%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-text">3.2.2 简单过程的应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E5%B0%86%E6%A1%86%E6%9E%B6%E7%9C%8B%E4%BD%9C%E5%B1%80%E9%83%A8%E7%8A%B6%E6%80%81%E7%9A%84%E5%B1%95%E5%8F%B0"><span class="toc-text">3.2.3 将框架看作局部状态的展台</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-4-%E5%86%85%E9%83%A8%E5%AE%9A%E4%B9%89"><span class="toc-text">3.2.4 内部定义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E7%94%A8%E5%8F%98%E5%8A%A8%E6%95%B0%E6%8D%AE%E5%81%9A%E6%A8%A1%E6%8B%9F"><span class="toc-text">3.3 用变动数据做模拟</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E5%8F%98%E5%8A%A8%E7%9A%84%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-text">3.3.1 变动的表结构</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">练习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1"><span class="toc-text">3.1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2"><span class="toc-text">3.2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3"><span class="toc-text">3.3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4"><span class="toc-text">3.4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5"><span class="toc-text">3.5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6"><span class="toc-text">3.6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7"><span class="toc-text">3.7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8"><span class="toc-text">3.8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9"><span class="toc-text">3.9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-10"><span class="toc-text">3.10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-11"><span class="toc-text">3.11</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-12"><span class="toc-text">3.12</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-13"><span class="toc-text">3.13</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-14"><span class="toc-text">3.14</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-15"><span class="toc-text">3.15</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-16"><span class="toc-text">3.16</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-17"><span class="toc-text">3.17</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-18"><span class="toc-text">3.18</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-19"><span class="toc-text">3.19</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2023 Oranges</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + SICP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%20(%E7%AC%AC%E4%B8%89%E7%AB%A0) + '&url=' + http%3A%2F%2Fexample.com%2F2023%2F07%2F02%2F3sicp%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/2023/07/02/3sicp/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
